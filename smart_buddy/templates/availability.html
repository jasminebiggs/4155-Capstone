<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set Availability</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>Set Your Weekly Availability</h1>
        <form id="availability-form">
            <div id="calendar">
                <!-- Calendar will be generated by JavaScript -->
            </div>
            <button type="submit">Save Availability</button>
        </form>
        <p id="message"></p>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const calendar = document.getElementById("calendar");
            const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
            const times = [];
            for (let i = 8; i < 22; i++) {
                times.push(`${i}:00 - ${i + 1}:00`);
            }

            days.forEach(day => {
                const dayDiv = document.createElement("div");
                dayDiv.classList.add("day");
                dayDiv.innerHTML = `<h3>${day}</h3>`;
                const timesDiv = document.createElement("div");
                timesDiv.classList.add("times");
                times.forEach(time => {
                    const timeSlot = document.createElement("div");
                    timeSlot.classList.add("time-slot");
                    const checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.name = day;
                    checkbox.value = time;
                    checkbox.id = `${day}-${time}`;
                    const label = document.createElement("label");
                    label.htmlFor = `${day}-${time}`;
                    label.textContent = time;
                    timeSlot.appendChild(checkbox);
                    timeSlot.appendChild(label);
                    timesDiv.appendChild(timeSlot);
                });
                dayDiv.appendChild(timesDiv);
                calendar.appendChild(dayDiv);
            });

            // Fetch and display current availability
            const token = localStorage.getItem("token");
            if (token) {
                fetch("/availability", {
                    headers: {
                        "Authorization": `Bearer ${token}`
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.availability) {
                        for (const [day, times] of Object.entries(data.availability)) {
                            times.forEach(time => {
                                const checkbox = document.getElementById(`${day}-${time}`);
                                if (checkbox) {
                                    checkbox.checked = true;
                                }
                            });
                        }
                    }
                });
            }


            document.getElementById("availability-form").addEventListener("submit", function (event) {
                event.preventDefault();
                const formData = new FormData(event.target);
                const availability = {};
                days.forEach(day => {
                    availability[day] = formData.getAll(day);
                });

                fetch("/availability", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({ availability: availability })
                })
                .then(response => response.json())
                .then(data => {
                    const message = document.getElementById("message");
                    message.textContent = data.message || "Availability updated!";
                })
                .catch(error => {
                    console.error("Error:", error);
                    const message = document.getElementById("message");
                    message.textContent = "An error occurred.";
                });
            });
        });
    </script>
</body>
</html>
